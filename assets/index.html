<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Whoot test 1</title>
    <!--link href="layout.css" rel="stylesheet" type="text/css"-->
    <!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../excanvas.min.js"></script><![endif]-->
    <script language="javascript" type="text/javascript" src="jquery.js"></script>
    <script language="javascript" type="text/javascript" src="jquery.flot.js"></script>
 </head>
    <body>

    <h2>Home</h2>

  <a href="/report.html">report</a>

  <form action="">
    ticks: <input type="text" id="myticks"  value="500" ><br>
  </form>

  <!--span><input class="submit" type="button" value="Submit" onclick="update_chart()"></span-->
  <!-- span><input class="submit" type="button" value="get_series() test" onclick="get_series('bitstamp.topask')"></span -->

  <span> 
    <div id="mytime" style="width:100px;height:30px;"></div>
    <div id="starttime" ></div>
  </span> 

    <div id="placeholder" style="width:800px;height:400px;"></div>

    <p>Simple example. </p>


  <!-- ok, we want to try to load a json file -->

<script type="text/javascript">

  var options = {
    series: {
      lines: {
        show: true
      }
//,
//        points: {
//          radius: 5,
//          fill: true,
//          show: true
//        }
    },
    yaxes: [
      {
        position: "right"
      },
      {
        position: "left"
      }
    ],
    xaxis: {
      mode: "time",
      // tickSize: [3, "minute"],
      tickLength: 0,
      // axisLabel: "2012",
      axisLabelUseCanvas: true,
      axisLabelFontSizePixels: 12,
      axisLabelFontFamily: 'Verdana, Arial',
      axisLabelPadding: 10,
      tickFormatter: function (val, axis) {
        //return dayOfWeek[new Date(val).getDay()];
        //return val.toLocaleTimeString()
        return new Date( val).toLocaleTimeString();
      }
    }
  };


  $(function () {
    // start
    all_series = [];
    graph = null ;
    last_id = -1;
//    continuous_update();

    get_series( 'btcmarkets.top_bid' );
    get_series( 'btcmarkets.top_ask' );

   // get_series('bitstamp.top_ask'); 
    //get_series('bitstamp.top_bid'); 

    continuous_update();
  });

  // we could actually keep this entire model on the server side if we wanted. 
  // but wouldn't it be better to be able to get individual series ...
  // yes. 
  // we could specify defaults - like {color, axis } 
  // so would it be better to update asynchronously.

  // eg. we have a bunch of series - when one of them are returned 
  // we redraw the model
  // we should know the name. 

  // i think we need to fire of an ajax request for every series 
  
  // ok, all_series should be kept about so that we can edit it.
  // it's actually a model.
  
  // IMPORTANT - we should be using backbone or something
  // if we request a series - we can get back the fully structured

 
  function find_index(a, predicate) {
    // must be a jquery equivalent
    for (var i = 0; i < a.length; i++) {
      if(predicate(a[i])) 
        return i;
    }
    return -1;
  }


  function merge_series( new_series ) {
    i = find_index( all_series, function( elt) { 
      return elt.series_name === new_series.series_name; 
    }); 
    //console.log( 'index is ' + i ); 
    if(i === -1) { 
      all_series.push( new_series );
    }
    else {
      all_series[i] = new_series;
    }
    console.log( 'all_series.length after merge ' + all_series.length ); 
  }

 
  function get_series( series_name_ ) {
    // MUST rename. this does more than get_series
    // call it add_series or something
    // it also updates the chart.
    // only one 
    // should pass the name
    // server should return the axis

    // actually not sure if we shoudn't have the series all there...    
    // and we then just keep the data up to date.
 
    $.ajax({
      dataType: "json",
      url: "get_series.json",
      data: { 
        ticks: $( "#myticks" )[0].value, 
        name: series_name_
      },

        // change series_name to just name
      success: function ( datax, textStatus, jqXHR ) {
        // ok, 
        console.log( 'whoot got series!!! ' + series_name_ );

        new_series = {
            series_name: series_name_, 
            color: "red", 
            label: "top ask",
            data: datax.map( function(x) {
              // its just going to be time value pairs
              return [ new Date( x.time), x.value ]
            }),
            yaxis: 1
        };
        merge_series( new_series ); 
        refresh_chart_data();
      },
      error: function (jqXHR, textStatus, errorThrown ) {
        console.log( textStatus  + errorThrown );
      }
    });
  }


  function refresh_chart_data() { 
    // rather than lexically bind everything - should use param
    // factor this into a function ...
    // actually we should even pass the all_series as an argument
    if( graph == null) {
      graph = $.plot($("#placeholder"), all_series, options );
      console.log( 'plotting graph')
    }
    else {
      console.log( 'already have graph')
      graph.setData( all_series );  // Replace oldData with newData
      graph.setupGrid();       // Adjust axes to match new values
      graph.draw();            // Update actual plot
    }
  }

  function continuous_update() {
    console.log('calling update');
    $.ajax({
      dataType: "json",
      url: "get_id.json",
      success: function ( id, textStatus, jqXHR ) {
        console.log( "id is " + id + " last_id " + last_id );
        if( id <= last_id ) {
          console.log( "nothing to update");
        }
        else {
          console.log( "require update");
          // we have to go through each 
          $.each( all_series, function( i, series) {
            console.log( 'MUST UPDATE ' + series.series_name );
            get_series( series.series_name ); 
          });
        }
      
        last_id = id;
      }
    });
    // IMPORTANT - we don't want to do this 
    // until everything has updated. like a 
    // thread join
    setTimeout(continuous_update, 10 * 1000 );
  }


</script>

 </body>
</html>
