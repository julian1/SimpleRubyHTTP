<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Whoot test 1</title>
    <!--link href="layout.css" rel="stylesheet" type="text/css"-->
    <!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../excanvas.min.js"></script><![endif]-->
    <script language="javascript" type="text/javascript" src="jquery.js"></script>
    <script language="javascript" type="text/javascript" src="jquery.flot.js"></script>
 </head>
    <body>

    <h2>Home</h2>

  <a href="/report.html">report</a>

  <form action="">
    ticks: <input type="text" id="myticks"  value="500" ><br>
  </form>

  <span><input class="submit" type="button" value="Submit" onclick="update_chart()"></span>
  <span><input class="submit" type="button" value="get_series() test" onclick="get_series('bitstamp.topask')"></span>

  <span> 
    <div id="mytime" style="width:100px;height:30px;"></div>
    <div id="starttime" ></div>
  </span> 

    <div id="placeholder" style="width:800px;height:400px;"></div>

    <p>Simple example. </p>


  <!-- ok, we want to try to load a json file -->

<script type="text/javascript">

  var options = {
    series: {
      lines: {
        show: true
      }
//,
//        points: {
//          radius: 5,
//          fill: true,
//          show: true
//        }
    },
    yaxes: [
      {
        position: "right"
      },
      {
        position: "left"
      }
    ],
    xaxis: {
      mode: "time",
      // tickSize: [3, "minute"],
      tickLength: 0,
      // axisLabel: "2012",
      axisLabelUseCanvas: true,
      axisLabelFontSizePixels: 12,
      axisLabelFontFamily: 'Verdana, Arial',
      axisLabelPadding: 10,
      tickFormatter: function (val, axis) {
        //return dayOfWeek[new Date(val).getDay()];
        //return val.toLocaleTimeString()
        return new Date( val).toLocaleTimeString();
      }
    }
  };


  $(function () {
    // start
    all_series = null;
    graph = null ;
    last_id = -1;
    continuous_update();

  });

  // we could actually keep this entire model on the server side if we wanted. 
  // but wouldn't it be better to be able to get individual series ...
  // yes. 
  // we could specify defaults - like {color, axis } 
  // so would it be better to update asynchronously.

  // eg. we have a bunch of series - when one of them are returned 
  // we redraw the model
  // we should know the name. 

  // i think we need to fire of an ajax request for every series 
  
  // ok, all_series should be kept about so that we can edit it.
  // it's actually a model.
  
  // IMPORTANT - we should be using backbone or something
  // if we request a series - we can get back the fully structured

  
  function get_series( series_name_ ) {
    // only one 
    // should pass the name
    // server should return the axis

    // actually not sure if we shoudn't have the series all there...    
    // and we then just keep the data up to date.
 
    $.ajax({
      dataType: "json",
      url: "get_series.json",
      data: { 
        ticks: $( "#myticks" )[0].value, 
        name: series_name_
      },
      success: function ( datax, textStatus, jqXHR ) {
        // ok, 
        console.log( 'whoot got series!!! ' + series_name_ );
        new_series = [
          {
            series_name: series_name_, 
            color: "red", 
            label: "top ask",
            data: datax.map( function(x) {
              // its just going to be time value pairs
              return [ new Date( x.time), x.value ]
            }),
            yaxis: 1
          }
        ]
        // now we should find and replace the series with a new one
        // and then call chart update 
      },
      error: function (jqXHR, textStatus, errorThrown ) {
        console.log( textStatus  + errorThrown );
      }
    });
  }




  function update_chart() {
    $.ajax({
      dataType: "json",
      url: "get_all_series.json",
      data: { ticks: $( "#myticks" )[0].value },
      success: function ( datax, textStatus, jqXHR ) {
        // ok, 
        console.log( 'whoot got data' );
        all_series = [
          {
            color: "red", 
            label: "top ask",
            data: datax.map( function(x) {
              return [ new Date( x.time), x.top_ask ]
            }),
            yaxis: 1
          },
          {
            label: "top bid",
            data: datax.map( function(x) {
              return [ new Date( x.time), x.top_bid ]
            }),
            yaxis: 1
          },
          {
            label: "sum ratio",
            data: datax.map( function(x) {
              return [ new Date( x.time), x.sum_ratio ]
            }),
            yaxis: 2
          }
        ];
        if( graph == null) {
          graph = $.plot($("#placeholder"), all_series, options );
          console.log( 'plotting graph')
        }
        else {
          console.log( 'already have graph')
          graph.setData( all_series );  // Replace oldData with newData
          graph.setupGrid();       // Adjust axes to match new values
          graph.draw();            // Update actual plot
        }
        // now we want to do update this thing
        x = datax.slice(-1)[0];
        y = new Date( x.time).toLocaleTimeString();
        $( "#mytime" ).html( "<p>" + y + "</p>" );

        x = datax.slice(0)[0];
        y = new Date( x.time).toLocaleString();
        $( "#starttime" ).html( "<p>" + y + "</p>" );
        last_id = x.id;
      } ,
      error: function (jqXHR, textStatus, errorThrown ) {
        console.log(   textStatus  + errorThrown );
      }
    });
  }

  function continuous_update() {
    console.log('calling update');
    $.ajax({
      dataType: "json",
      url: "get_id.json",
      success: function ( id, textStatus, jqXHR ) {
        console.log( "id is " + id + " last_id " + last_id );
        if( id <= last_id ) {
          console.log( "nothing to update");
        }
        else {
          console.log( "require update");
          update_chart();
        }
      }
    });
    setTimeout(continuous_update, 10 * 1000 );
  }


</script>

 </body>
</html>
